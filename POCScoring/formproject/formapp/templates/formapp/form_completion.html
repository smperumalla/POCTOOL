<!DOCTYPE html>
{% load static %}
<html>
<head>
    <title>Form Completion</title>
    <!-- styles as before -->
</head>
<body>
    <form id="completion-form" method="post">
        {% csrf_token %}
        <h2>{{ assignment.form.title }}</h2>
        <!-- Loop through each section -->
        {% for section in sections %}
            <h3>{{ section.title }}</h3>
            <!-- Loop through each subsection in the section -->
            {% for subsection in section.subsection_set.all %}
                <h4>{{ subsection.title }}</h4>
                <!-- Loop through each question in the subsection -->
                {% for question in subsection.question_set.all %}
                    <label for="question-{{ question.id }}">{{ question.text }}</label>
                    <input type="number" id="question-{{ question.id }}" name="question-{{ question.id }}" min="0" max="5" required>
                {% endfor %}
            {% endfor %}
        {% endfor %}
        <input type="submit" value="Submit">
    </form>
    <script>
        document.getElementById('completion-form').addEventListener('submit', function(event) {
            event.preventDefault();
    
            var formData = {};
            {% for section in sections %}
                {% for subsection in section.subsection_set.all %}
                    {% for question in subsection.question_set.all %}
                        formData["{{ question.id }}"] = document.getElementById('question-{{ question.id }}').value;
                    {% endfor %}
                {% endfor %}
            {% endfor %}
            console.log(formData);
            var jsonData = JSON.stringify(formData);
            console.log(jsonData);  // For debugging purpose, you should see this on browser console
    
            fetch("{% url 'form_completion' assignment.id %}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                },
                body: jsonData
            }).then(function(response) {
                if(response.ok) {
                    window.location.href = response.url;  // Redirect to the URL provided by the server
                } else {
                    alert("Error: " + response.statusText);
                }
            });
        });
    </script>
</body>
</html>
